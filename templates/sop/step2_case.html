{% extends 'sop/base_sop.html' %}

{% block sop_body %}
  <form method="post" novalidate id="case-form">
    {% csrf_token %}
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label">{{ form.primary_diagnosis.label }}</label>
            {{ form.primary_diagnosis }}
            {% if form.primary_diagnosis.errors %}
              <div class="text-danger small mt-1">{{ form.primary_diagnosis.errors.as_text|striptags }}</div>
            {% endif %}
          </div>

          <div class="col-md-6">
            <label class="form-label">{{ form.diagnosis_date.label }}</label>
            {{ form.diagnosis_date }}
            {% if form.diagnosis_date.errors %}
              <div class="text-danger small mt-1">{{ form.diagnosis_date.errors.as_text|striptags }}</div>
            {% endif %}
            <div class="form-text text-muted" style="font-size: 0.75rem;">
              La fecha no puede ser futura (solo fechas pasadas o hoy)
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">{{ form.localidad.label }}</label>
            {{ form.localidad }}
            {% if form.localidad.errors %}
              <div class="text-danger small mt-1">{{ form.localidad.errors.as_text|striptags }}</div>
            {% endif %}
          </div>

          <div class="col-12">
            <label class="form-label">{{ form.referring_institution.label }}</label>
            {{ form.referring_institution }}
            {% if form.referring_institution.errors %}
              <div class="text-danger small mt-1">{{ form.referring_institution.errors.as_text|striptags }}</div>
            {% endif %}
          </div>

          <div class="col-12">
            <label class="form-label">{{ form.main_symptoms.label }}</label>
            {{ form.main_symptoms }}
            {% if form.main_symptoms.errors %}
              <div class="text-danger small mt-1">{{ form.main_symptoms.errors.as_text|striptags }}</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between">
      <a href="{% url 'cases:sop_start' %}" class="btn btn-outline-secondary">Volver</a>
      <button type="submit" class="btn btn-new-case">Continuar al Paso 3</button>
    </div>
  </form>

  <script>
    // Validaci贸n de fecha de diagn贸stico - no puede ser futura
    document.addEventListener('DOMContentLoaded', function() {
      const dateInput = document.querySelector('input[name="case_diagnosis_date"]');
      if (dateInput) {
        // Obtener la fecha de hoy en formato YYYY-MM-DD
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const maxDate = `${year}-${month}-${day}`;
        
        // Establecer el atributo max para evitar fechas futuras
        dateInput.max = maxDate;
        
        // Validaci贸n al enviar el formulario
        const form = document.getElementById('case-form');
        if (form) {
          form.addEventListener('submit', function(e) {
            const selectedDate = new Date(dateInput.value);
            const todayDate = new Date();
            todayDate.setHours(0, 0, 0, 0);
            selectedDate.setHours(0, 0, 0, 0);
            
            if (selectedDate > todayDate) {
              e.preventDefault();
              alert('La fecha de diagn贸stico no puede ser futura. Por favor seleccione una fecha anterior o igual a hoy.');
              dateInput.focus();
              return false;
            }
          });
        }
      }
    });
  </script>
{% endblock %}
