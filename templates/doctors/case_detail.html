<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Detalle Caso - {{ case.case_id }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">Segunda Opinión Médica</a>
        <div class="d-flex">
            <span class="me-3">Dr(a). {{ user.medico.nombre_completo }}</span>
            <a class="btn btn-outline-secondary" href="{% url 'cases:doctor_dashboard' %}">Volver</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h3>Caso {{ case.case_id }}</h3>
    <p><strong>Diagnóstico actual:</strong> {{ case.primary_diagnosis }}</p>
    <p><strong>Fecha de diagnóstico:</strong> {% if case.diagnosis_date %}{{ case.diagnosis_date }}{% else %}No especificada{% endif %}</p>
    <p><strong>Especialidad solicitada:</strong> {{ case.specialty_required }}</p>
    <p><strong>Descripción / Síntomas:</strong> {{ case.description }}</p>
    <p><strong>Localidad:</strong> {% if case.localidad %}{{ case.localidad.nombre }}{% else %}No especificada{% endif %}</p>
    <p><strong>Paciente:</strong> {% if patient_profile %}{{ patient_profile.full_name }}{% else %}{{ case.patient.email }}{% endif %}</p>
    <p><strong>Estado:</strong> {{ case.get_status_display }}</p>

    {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <div class="card mb-3">
        <div class="card-header">Documentos</div>
        <div class="card-body">
            {% if documents %}
                <div class="list-group">
                {% for doc in documents %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ doc.file_name }}</strong>
                            <div class="text-muted small">{{ doc.get_document_type_display }}</div>
                        </div>
                        <div>
                            {% if doc.file %}
                                <a class="btn btn-sm btn-outline-primary" href="{{ doc.file.url }}" target="_blank" rel="noopener">Ver</a>
                                <a class="btn btn-sm btn-outline-secondary" href="{{ doc.file.url }}" download>Descargar</a>
                            {% else %}
                                <span class="text-muted">Sin archivo</span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
                </div>
            {% else %}
                <p>No hay documentos adjuntos.</p>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header">Responder como médico</div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label">Diagnóstico propuesto</label>
                                <textarea name="diagnostico_propuesto" class="form-control" rows="4">{% if opinion %}{{ opinion.opinion_text }}{% endif %}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tratamiento recomendado</label>
                                <textarea name="tratamiento_recomendado" class="form-control" rows="3">{% if opinion %}{{ opinion.recommendations }}{% endif %}</textarea>
                            </div>
                <div class="mb-3">
                    <label class="form-label">Observaciones</label>
                    <textarea name="observaciones" class="form-control" rows="3">{% if opinion %}{{ opinion.observation }}{% endif %}</textarea>
                </div>
                <div class="mb-3 form-check">
                    <input class="form-check-input" type="checkbox" name="coincide" id="coincide" value="yes">
                    <label class="form-check-label" for="coincide">Coincide con diagnóstico original</label>
                </div>
                <button type="submit" class="btn btn-primary">Enviar respuesta</button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
